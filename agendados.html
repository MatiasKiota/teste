<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Pedidos Agendados - Del√≠cias da Mamis</title>
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Quicksand', sans-serif;
      background-color: #ffe6f0;
      margin: 0; padding: 20px;
      color: #333;
    }
    
    h1 {
      color: #cc3399;
      text-align: center;
      margin-bottom: 20px;
    }
    .container {
      max-width: 700px;
      background: #fff0f8;
      border-radius: 12px;
      padding: 20px;
      margin: 0 auto;
      box-shadow: 0 0 15px #ff99cc;
    }
    h3 {
      color: #b3006a;
      margin-top: 20px;
      margin-bottom: 10px;
    }
    p {
      margin: 6px 0;
    }
    strong {
      color: #cc3399;
    }
    #nenhumPedido {
      text-align: center;
      font-size: 1.2em;
      margin-top: 100px;
      color: #b3006a;
    }
    button.voltar {
      display: block;
      margin: 30px auto 0;
      padding: 10px 20px;
      background-color: #ff66cc;
      border: none;
      border-radius: 12px;
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    button.voltar:hover {
      background-color: #ff33aa;
    }
    button#btnApagarTudo {
      background-color: #ff3366;
      color: white;
      padding: 10px 20px;
      font-size: 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin-bottom: 20px;
      display: block;
      margin-left: auto;
      margin-right: auto;
    }
    button#btnApagarTudo:hover {
      background-color: #cc2a56;
    }
    
  </style>
</head>
<body>

  <h1>üìÖ Pedidos Agendados</h1>
  
  <button id="btnApagarTudo" onclick="apagarTudo()">üßπ Apagar TODOS os pedidos agendados</button>

  <div id="containerPedidos" class="container" style="display:none;">
    <!-- Conte√∫do do pedido agendado ser√° inserido aqui via JS -->
  </div>

  <div id="nenhumPedido">Nenhum pedido agendado no momento.</div>

  <button class="voltar" onclick="window.history.back()">‚Üê Voltar</button>

<script>
  const get = (key) => localStorage.getItem(key) || 'N√£o informado';

  // Pega tipo de entrega, s√≥ pra saber se √© agendamento
  const entrega = localStorage.getItem('tipoEntrega') || '';
  const pedidoAgendado = entrega === 'Agendamento Delivery' || entrega === 'Agendamento Retirada';

  // Pega lista salva
  let listaPedidos = JSON.parse(localStorage.getItem('listaPedidosAgendados') || '[]');

  // Construir um objeto novo de pedido (igual na confirma√ß√£o)
  const novoPedido = {
    tipoEntrega: entrega,
    itensCarrinho: JSON.parse(localStorage.getItem('itensCarrinho')) || [],
    valorPedido: parseFloat(localStorage.getItem('valorPedido')) || 0,
    agendamentoData: localStorage.getItem('agendamentoData') || '',
    agendamentoHora: localStorage.getItem('agendamentoHora') || '',
    formaPagamento: localStorage.getItem('formaPagamento') || 'N√£o informado',
    cep: get('cep'),
    cidade: get('cidade'),
    bairro: get('bairro'),
    rua: get('rua'),
    numero: get('numero'),
    complemento: get('complemento'),
    referencia: get('referencia'),
    observacaoPedido: localStorage.getItem('observacaoPedido') || 'Nenhuma observa√ß√£o',
    nome: get('nome'),
    telefone: get('telefone')
  };

  // Fun√ß√£o para comparar dois pedidos (simplificado: comparar nome + data + hora + valor)
  function isPedidoIgual(p1, p2) {
    return (
      p1.nome === p2.nome &&
      p1.agendamentoData === p2.agendamentoData &&
      p1.agendamentoHora === p2.agendamentoHora &&
      p1.valorPedido === p2.valorPedido
    );
  }

  // S√≥ adiciona novo pedido se for agendado e n√£o estiver duplicado
  if (pedidoAgendado && novoPedido.agendamentoData && novoPedido.agendamentoHora) {
    const existe = listaPedidos.some(p => isPedidoIgual(p, novoPedido));
    if (!existe) {
      listaPedidos.unshift(novoPedido);
      localStorage.setItem('listaPedidosAgendados', JSON.stringify(listaPedidos));
    }
  }

  // Agora ordenar e mostrar pedidos
  listaPedidos.sort((a, b) => {
    const dataA = new Date(`${a.agendamentoData} ${a.agendamentoHora}`);
    const dataB = new Date(`${b.agendamentoData} ${b.agendamentoHora}`);
    return dataA - dataB;
  });

  if (listaPedidos.length > 0) {
    const container = document.getElementById('containerPedidos');
    container.style.display = 'block';
    document.getElementById('nenhumPedido').style.display = 'none';

    const cepLoja = '06160201';

    function calcularFrete(cepDestino) {
      const cepNumCliente = parseInt(cepDestino.replace(/\D/g, '')) || 0;
      const cepNumLoja = parseInt(cepLoja);
      const diff = Math.abs(cepNumCliente - cepNumLoja);
      if (diff <= 100) return 0;
      else if (diff <= 300) return 0;
      else if (diff <= 600) return 3;
      else if (diff <= 1000) return 6;
      else if (diff <= 1300) return 9;
      else if (diff <= 1600) return 12;
      else if (diff <= 1900) return 15;
      else if (diff <= 2000) return 18;
      else if (diff <= 2300) return 21;
      else return 24;
    }

    // Agrupar por data
    const agrupadosPorData = {};
    listaPedidos.forEach(pedido => {
      if (!agrupadosPorData[pedido.agendamentoData]) {
        agrupadosPorData[pedido.agendamentoData] = [];
      }
      agrupadosPorData[pedido.agendamentoData].push(pedido);
    });

    let htmlPedidos = `<p style="text-align:center; font-size:1.2em; color:#b3006a; font-weight:bold;">Voc√™ tem ${listaPedidos.length} pedidos agendados!</p>`;

    Object.keys(agrupadosPorData).forEach(data => {
      htmlPedidos += `<h3 style="text-align:center; background:#ffe0ef; border-radius:8px; padding:8px; margin-top:30px;">üìÖ ${data}</h3>`;
      agrupadosPorData[data].forEach((pedido, i) => {
        let frete = 0;
        if (pedido.tipoEntrega === 'Agendamento Delivery') {
          frete = calcularFrete(pedido.cep);
        }

        const totalGeral = pedido.valorPedido + frete;
        const itensTexto = pedido.itensCarrinho.map(item => `${item.quantidade}x ${item.nome}`).join(', ') || 'Nenhum item';

        const entregaTexto = pedido.tipoEntrega === 'Agendamento Delivery'
          ? `Entrega agendada: ${pedido.agendamentoData} √†s ${pedido.agendamentoHora}`
          : `Retirada agendada: ${pedido.agendamentoData} √†s ${pedido.agendamentoHora}`;

        const isRetirada = pedido.tipoEntrega === 'Agendamento Retirada';
        const enderecoHtml = isRetirada
          ? `
          <p><strong>Endere√ßo para Retirada:</strong></p>
          <p>Rua Zumbi dos Palmares, 140</p>
          <p>Bairro Bandeiras ‚Äì Osasco ‚Äì SP</p>
          <p>CEP: 06160-201</p>`
          : `
          <p><strong>CEP:</strong> ${pedido.cep}</p>
          <p><strong>Cidade:</strong> ${pedido.cidade}</p>
          <p><strong>Bairro:</strong> ${pedido.bairro}</p>
          <p><strong>Rua:</strong> ${pedido.rua}</p>
          <p><strong>N√∫mero:</strong> ${pedido.numero}</p>
          <p><strong>Complemento:</strong> ${pedido.complemento}</p>
          <p><strong>Refer√™ncia:</strong> ${pedido.referencia}</p>`;

        const tipoPagamento = 'Pagamento na Retirada';

        const idDetalhes = `detalhes-${data}-${i}`;

        htmlPedidos += `
          <div style="margin-bottom: 20px; border: 2px dashed #ff99cc; border-radius: 10px; padding: 15px;">
            <p><strong>üïí Hor√°rio:</strong> ${pedido.agendamentoHora}</p>
            <button onclick="toggleDetalhes('${idDetalhes}', this)" style="background:#ff66cc; color:white; border:none; padding:8px 14px; border-radius:10px; font-weight:600; cursor:pointer; margin-top:8px;">
              ‚¨áÔ∏è Ver Detalhes
            </button>
            <div id="${idDetalhes}" style="display:none; margin-top:15px; background:#fff; padding:10px; border-radius:8px;">
              <p><strong>Itens:</strong> ${itensTexto}</p>
              <p><strong>Total Produtos:</strong> R$ ${pedido.valorPedido.toFixed(2).replace('.', ',')}</p>
              <p><strong>Frete:</strong> R$ ${frete.toFixed(2).replace('.', ',')}</p>
              <p><strong>Total a Pagar:</strong> R$ ${totalGeral.toFixed(2).replace('.', ',')}</p>
              <p><strong>Observa√ß√£o:</strong> ${pedido.observacaoPedido}</p>
              <h4 style="margin-top:10px;">Forma de Entrega</h4>
              <p>${entregaTexto}</p>
              <h4>Forma de Pagamento</h4>
              <p><strong>Tipo:</strong> ${tipoPagamento}</p>
              <p><strong>M√©todo:</strong> ${pedido.formaPagamento}</p>
              <h4>Dados do Cliente</h4>
              <p><strong>Nome:</strong> ${pedido.nome}</p>
              <p><strong>Telefone:</strong> ${pedido.telefone}</p>
              ${enderecoHtml}
            </div>
          </div>
        `;
      });
    });

    document.getElementById('containerPedidos').innerHTML = htmlPedidos;

  } else {
    document.getElementById('containerPedidos').style.display = 'none';
    document.getElementById('nenhumPedido').style.display = 'block';
  }

  // Fun√ß√£o para alternar exibi√ß√£o com anima√ß√£o e mudar √≠cone
  function toggleDetalhes(id, btn) {
    const el = document.getElementById(id);
    if (el.style.display === 'none') {
      el.style.display = 'block';
      btn.innerHTML = '‚¨ÜÔ∏è Fechar Detalhes';
    } else {
      el.style.display = 'none';
      btn.innerHTML = '‚¨áÔ∏è Ver Detalhes';
    }
  }

  // Fun√ß√£o para apagar tudo
  function apagarTudo() {
    if (confirm("Tem certeza que deseja apagar TODOS os pedidos agendados?")) {
      localStorage.removeItem('listaPedidosAgendados');
      location.reload();
    }
  }
  // --- C√≥digo novo para buscar e exibir pedidos PIX ---
// Isso roda depois que todo seu c√≥digo j√° rodou

(function() {
  // Fun√ß√£o para buscar pedidos PIX do localStorage
  function buscarPedidosPix() {
    const pedidosPix = [];
    for (let i = 0; i < localStorage.length; i++) {
      const chave = localStorage.key(i);
      if (chave.startsWith('pedidos_')) {
        try {
          const lista = JSON.parse(localStorage.getItem(chave));
          if (Array.isArray(lista)) {
            lista.forEach(p => {
              pedidosPix.push({
                tipoEntrega: p.entrega || 'PIX',
                itensCarrinho: p.itens || [],
                valorPedido: parseFloat(p.total) || 0,
                agendamentoData: p.agendamentoData || '',
                agendamentoHora: p.agendamentoHora || '',
                formaPagamento: p.pagamento || 'PIX',
                cep: p.cep || '',
                cidade: p.cidade || '',
                bairro: p.bairro || '',
                rua: p.rua || '',
                numero: p.numero || '',
                complemento: p.complemento || '',
                referencia: p.referencia || '',
                observacaoPedido: p.observacao || 'Nenhuma observa√ß√£o',
                nome: p.nome || 'N√£o informado',
                telefone: p.celular || 'N√£o informado'
              });
            });
          }
        } catch(e) { /* ignorar erro json */ }
      }
    }
    return pedidosPix;
  }

  // Pega o container atual e pedidos j√° carregados no script original
  const container = document.getElementById('containerPedidos');
  const nenhumPedidoDiv = document.getElementById('nenhumPedido');

  // Pega os pedidos agendados do localStorage (como seu script j√° fez)
  let listaPedidos = JSON.parse(localStorage.getItem('listaPedidosAgendados') || '[]');

  // Busca pedidos PIX
  const pedidosPix = buscarPedidosPix();

  // Junta PIX com agendados
  listaPedidos = listaPedidos.concat(pedidosPix);

  // Ordena (mesmo crit√©rio do seu script)
  listaPedidos.sort((a, b) => {
    const dataA = new Date(`${a.agendamentoData || '1970-01-01'} ${a.agendamentoHora || '00:00'}`);
    const dataB = new Date(`${b.agendamentoData || '1970-01-01'} ${b.agendamentoHora || '00:00'}`);
    return dataA - dataB;
  });

  if (listaPedidos.length > 0) {
    container.style.display = 'block';
    nenhumPedidoDiv.style.display = 'none';

    // Fun√ß√£o para calcular frete (copiada do seu script)
    const cepLoja = '06160201';
    function calcularFrete(cepDestino) {
      const cepNumCliente = parseInt(cepDestino.replace(/\D/g, '')) || 0;
      const cepNumLoja = parseInt(cepLoja);
      const diff = Math.abs(cepNumCliente - cepNumLoja);
      if (diff <= 100) return 0;
      else if (diff <= 300) return 0;
      else if (diff <= 600) return 3;
      else if (diff <= 1000) return 6;
      else if (diff <= 1300) return 9;
      else if (diff <= 1600) return 12;
      else if (diff <= 1900) return 15;
      else if (diff <= 2000) return 18;
      else if (diff <= 2300) return 21;
      else return 24;
    }

    // Agrupar por data
    const agrupadosPorData = {};
    listaPedidos.forEach(pedido => {
      const chaveData = pedido.agendamentoData || 'Sem data';
      if (!agrupadosPorData[chaveData]) {
        agrupadosPorData[chaveData] = [];
      }
      agrupadosPorData[chaveData].push(pedido);
    });

    // Montar html dos pedidos (igual seu script)
    let htmlPedidos = `<p style="text-align:center; font-size:1.2em; color:#b3006a; font-weight:bold;">Voc√™ tem ${listaPedidos.length} pedidos agendados!</p>`;

    Object.keys(agrupadosPorData).forEach(data => {
      htmlPedidos += `<h3 style="text-align:center; background:#ffe0ef; border-radius:8px; padding:8px; margin-top:30px;">üìÖ ${data}</h3>`;
      agrupadosPorData[data].forEach((pedido, i) => {
        let frete = 0;
        if (pedido.tipoEntrega === 'Agendamento Delivery') {
          frete = calcularFrete(pedido.cep);
        }

        const totalGeral = pedido.valorPedido + frete;
        const itensTexto = pedido.itensCarrinho.map(item => `${item.quantidade}x ${item.nome}`).join(', ') || 'Nenhum item';

        const entregaTexto = pedido.tipoEntrega === 'Agendamento Delivery'
          ? `Entrega agendada: ${pedido.agendamentoData} √†s ${pedido.agendamentoHora}`
          : pedido.tipoEntrega === 'Agendamento Retirada'
            ? `Retirada agendada: ${pedido.agendamentoData} √†s ${pedido.agendamentoHora}`
            : `Tipo de entrega: ${pedido.tipoEntrega || 'N√£o informado'}`;

        const isRetirada = pedido.tipoEntrega === 'Agendamento Retirada';
        const enderecoHtml = isRetirada
          ? `
          <p><strong>Endere√ßo para Retirada:</strong></p>
          <p>Rua Zumbi dos Palmares, 140</p>
          <p>Bairro Bandeiras ‚Äì Osasco ‚Äì SP</p>
          <p>CEP: 06160-201</p>`
          : `
          <p><strong>CEP:</strong> ${pedido.cep}</p>
          <p><strong>Cidade:</strong> ${pedido.cidade}</p>
          <p><strong>Bairro:</strong> ${pedido.bairro}</p>
          <p><strong>Rua:</strong> ${pedido.rua}</p>
          <p><strong>N√∫mero:</strong> ${pedido.numero}</p>
          <p><strong>Complemento:</strong> ${pedido.complemento}</p>
          <p><strong>Refer√™ncia:</strong> ${pedido.referencia}</p>`;

        const tipoPagamento = pedido.formaPagamento || 'N√£o informado';

        const idDetalhes = `detalhes-${data}-${i}`;

        htmlPedidos += `
          <div style="margin-bottom: 20px; border: 2px dashed #ff99cc; border-radius: 10px; padding: 15px;">
            <p><strong>üïí Hor√°rio:</strong> ${pedido.agendamentoHora || '-'}</p>
            <button onclick="toggleDetalhes('${idDetalhes}', this)" style="background:#ff66cc; color:white; border:none; padding:8px 14px; border-radius:10px; font-weight:600; cursor:pointer; margin-top:8px;">
              ‚¨áÔ∏è Ver Detalhes
            </button>
            <div id="${idDetalhes}" style="display:none; margin-top:15px; background:#fff; padding:10px; border-radius:8px;">
              <p><strong>Itens:</strong> ${itensTexto}</p>
              <p><strong>Total Produtos:</strong> R$ ${pedido.valorPedido.toFixed(2).replace('.', ',')}</p>
              <p><strong>Frete:</strong> R$ ${frete.toFixed(2).replace('.', ',')}</p>
              <p><strong>Total a Pagar:</strong> R$ ${totalGeral.toFixed(2).replace('.', ',')}</p>
              <p><strong>Observa√ß√£o:</strong> ${pedido.observacaoPedido}</p>
              <h4 style="margin-top:10px;">Forma de Entrega</h4>
              <p>${entregaTexto}</p>
              <h4>Forma de Pagamento</h4>
              <p><strong>Tipo:</strong> ${tipoPagamento}</p>
              <p><strong>M√©todo:</strong> ${pedido.formaPagamento}</p>
              <h4>Dados do Cliente</h4>
              <p><strong>Nome:</strong> ${pedido.nome}</p>
              <p><strong>Telefone:</strong> ${pedido.telefone}</p>
              ${enderecoHtml}
            </div>
          </div>
        `;
      });
    });

    container.innerHTML = htmlPedidos;

  } else {
    container.style.display = 'none';
    nenhumPedidoDiv.style.display = 'block';
  }

  // A fun√ß√£o toggleDetalhes j√° est√° no seu script original, n√£o precisa repetir
})();

</script>
<!-- Estrelas brilhantes -->
<style>
  .stars-container {
    pointer-events: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    overflow: visible;
    z-index: 9999;
  }
  .star {
    position: absolute;
    width: 6px;
    height: 6px;
    background: white;
    border-radius: 50%;
    filter: drop-shadow(0 0 3px white);
    opacity: 0.8;
    animation-name: twinkle;
    animation-timing-function: ease-in-out;
    animation-iteration-count: infinite;
  }
  @keyframes twinkle {
    0%, 100% { opacity: 0.8; transform: scale(1); }
    50% { opacity: 0.2; transform: scale(0.7); }
  }
</style>

<div class="stars-container" id="stars-container"></div>

<script>
  const starsContainer = document.getElementById('stars-container');
  const numStars = 50;
  for(let i = 0; i < numStars; i++) {
    const star = document.createElement('div');
    star.classList.add('star');
    star.style.top = (Math.random() * 100) + 'vh';
    star.style.left = (Math.random() * 100) + 'vw';
    star.style.animationDuration = (1.5 + Math.random() * 2) + 's';
    star.style.animationDelay = (Math.random() * 5) + 's';
    starsContainer.appendChild(star);
  }
</script>

</body>
</html>
